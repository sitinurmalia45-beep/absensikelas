<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Kelas Online (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page-active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-input { transition: all 0.2s ease-in-out; }
        .form-input:focus-within { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); }

        .modal-backdrop { background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { animation: slideInUp 0.4s; }
        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white/50 backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500"></div>
    </div>

    <!-- Container Utama -->
    <div id="app" class="min-h-screen p-4 flex items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1470770841072-f978cf4d019e?q=80&w=1470&auto=format&fit=crop')">

        <!-- Halaman Login -->
        <div id="login-page" class="page w-full max-w-md">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-2xl rounded-2xl p-8 space-y-6">
                <div class="text-center">
                    <i class="ph-duotone ph-student text-5xl text-teal-500"></i>
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-white mt-2">Selamat Datang!</h1>
                    <p class="text-gray-500 dark:text-gray-400">Login ke Sistem Absensi</p>
                </div>
                <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"></div>
                <div class="space-y-4">
                    <div class="relative form-input">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="ph-user text-gray-400"></i></span>
                        <input type="text" id="login-username" placeholder="Username" class="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="relative form-input">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="ph-lock text-gray-400"></i></span>
                        <input type="password" id="login-password" placeholder="Password" class="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                </div>
                <button onclick="handleLogin()" class="w-full flex items-center justify-center bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-transform duration-200 hover:scale-105 shadow-lg hover:shadow-teal-400/50">
                    <i class="ph-sign-in mr-2"></i> Login
                </button>
                <p class="text-center text-sm">Belum punya akun? <a href="#" onclick="showPage('register-page')" class="text-teal-500 hover:underline">Registrasi di sini</a></p>
            </div>
        </div>
        
        <!-- Halaman Registrasi -->
        <div id="register-page" class="page w-full max-w-md">
             <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-2xl rounded-2xl p-8 space-y-4">
                <h1 class="text-2xl font-bold text-center">Registrasi Akun Baru</h1>
                <div id="register-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"></div>
                <input type="email" id="register-email" placeholder="Email" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg">
                <input type="password" id="register-password" placeholder="Password" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg">
                <input type="text" id="register-name" placeholder="Nama Lengkap" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg">
                <input type="text" id="register-username" placeholder="Username" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg">
                <select id="register-role" onchange="toggleKelasSelection()" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg">
                    <option value="siswa">Siswa</option>
                    <option value="guru">Guru</option>
                </select>
                <select id="register-kelas" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-gray-300 rounded-lg">
                    <option value="XII-D">XII-D</option>
                </select>
                <button onclick="handleRegister()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">Registrasi</button>
                 <p class="text-center text-sm">Sudah punya akun? <a href="#" onclick="showPage('login-page')" class="text-teal-500 hover:underline">Login di sini</a></p>
             </div>
        </div>

        <!-- Halaman Utama Aplikasi (Dashboard) -->
        <div id="dashboard-page" class="page w-full max-w-7xl mx-auto">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-2xl rounded-2xl p-6 md:p-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Dashboard Absensi</h1>
                        <p id="welcome-message" class="text-gray-500"></p>
                    </div>
                    <button onclick="handleLogout()" class="mt-4 md:mt-0 flex items-center bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-transform duration-200 hover:scale-105">
                        <i class="ph-sign-out mr-2"></i>Logout
                    </button>
                </div>
                <div id="dashboard-content"></div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Tambah/Edit User -->
    <div id="user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <div id="modal-error" class="hidden bg-red-100 text-red-700 p-3 rounded-md mb-4"></div>
            <input type="hidden" id="modal-user-id">
            <input type="hidden" id="modal-user-role">
            <div class="space-y-4">
                <input type="text" id="modal-name" placeholder="Nama Lengkap" class="w-full p-2 border rounded">
                <input type="text" id="modal-username" placeholder="Username" class="w-full p-2 border rounded">
                <input type="email" id="modal-email" placeholder="Email" class="w-full p-2 border rounded">
                <input type="text" id="modal-password" placeholder="Password (biarkan kosong jika tidak diubah)" class="w-full p-2 border rounded">
                <select id="modal-kelas" class="w-full p-2 border rounded">
                    <option value="XII-D">XII-D</option>
                </select>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md">Batal</button>
                <button onclick="handleSaveUser()" class="px-4 py-2 bg-teal-600 text-white rounded-md">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        // PENTING: Ganti nilai di bawah ini dengan URL dan Kunci API dari proyek Supabase Anda.
        const SUPABASE_URL = 'https://hkbvarmdnrvzjnpaumuq.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrYnZhcm1kbnJ2empucGF1bXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTc0MDIsImV4cCI6MjA3NjAzMzQwMn0.0SOfoY2S19orbuYnU6Wvc7qapRwRyK9b2VPwGhTvCJU';
        
        let supabase;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                throw new Error("Supabase library (supabase-js) gagal dimuat. Periksa koneksi internet.");
            }
        } catch (error) {
            console.error("Supabase initialization failed:", error.message);
            const loginError = document.getElementById('login-error');
            if (loginError) {
                loginError.textContent = "Error Inisialisasi: " + error.message;
                loginError.classList.remove('hidden');
            }
        }

        // --- GLOBAL STATE ---
        let users = [], attendanceRecords = [], teacherAttendanceRecords = [];
        let currentUser = null;

        // --- UI HELPER FUNCTIONS ---
        const spinner = document.getElementById('loading-spinner');
        const showSpinner = () => spinner.classList.remove('hidden');
        const hideSpinner = () => spinner.classList.add('hidden');

        window.showPage = (pageId) => {
            document.querySelectorAll('#app > div.page').forEach(div => div.classList.remove('page-active'));
            const page = document.getElementById(pageId);
            if(page) page.classList.add('page-active');
        };

        window.toggleKelasSelection = (isModal = false) => { 
            const role = isModal ? document.getElementById('modal-user-role').value : document.getElementById('register-role').value;
            const kelasEl = isModal ? document.getElementById('modal-kelas') : document.getElementById('register-kelas');
            kelasEl.style.display = role === 'siswa' ? 'block' : 'none'; 
        };
        function getTodayDateString() { const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getCurrentTimeString() { const now = new Date(); const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        
        // --- DATA FUNCTIONS (SUPABASE) ---
        async function loadAllData() {
            showSpinner();
            try {
                const { data: usersData, error: usersError } = await supabase.from('user').select('*'); // Ganti 'users' menjadi 'user'
                if (usersError) throw usersError;
                users = usersData;

                const { data: recordsData, error: recordsError } = await supabase.from('attendance_records').select('*');
                if (recordsError) throw recordsError;
                attendanceRecords = recordsData;

                const { data: teacherRecordsData, error: teacherRecordsError } = await supabase.from('teacher_attendance_records').select('*');
                if (teacherRecordsError) throw teacherRecordsError;
                teacherAttendanceRecords = teacherRecordsData;

            } catch (error) {
                console.error("Error loading data:", error.message);
                alert("Gagal memuat data dari database. Pastikan konfigurasi Supabase sudah benar dan RLS (jika aktif) memperbolehkan SELECT.");
            } finally {
                hideSpinner();
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard() {
            if (!currentUser) return;
            document.getElementById('welcome-message').textContent = `Selamat datang, ${currentUser.nama} | Peran: ${currentUser.role}`;
            const contentDiv = document.getElementById('dashboard-content');
            contentDiv.innerHTML = '';
            switch(currentUser.role) {
                case 'admin': contentDiv.innerHTML = renderAdminDashboard(); break;
                case 'guru': contentDiv.innerHTML = currentUser.status !== 'disetujui' ? `<div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg">Akun Anda sedang menunggu persetujuan dari admin.</div>` : renderGuruDashboard(); attachGuruEventListeners(); break;
                case 'siswa': contentDiv.innerHTML = renderSiswaDashboard(); attachSiswaEventListeners(); break;
            }
        }
        
        function renderAdminDashboard() {
            const imageHTML = `<div class="mb-6"><img src="https://images.unsplash.com/photo-1577896851231-70ef18881754?q=80&w=1470&auto=format&fit=crop" alt="Ilustrasi belajar mengajar" class="w-full h-48 object-cover rounded-lg shadow-md"></div>`;
            
            // --- BAGIAN MANAJEMEN ---
            let teacherRows = '';
            users.filter(u => u.role === 'guru').forEach(teacher => {
                teacherRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${teacher.nama}</td><td class="p-3">${teacher.email}</td><td class="p-3">${teacher.status}</td><td class="p-3 space-x-2"><button onclick="openModal(${teacher.id})" class="text-blue-500 hover:underline">Edit</button><button onclick="handleDeleteUser(${teacher.id})" class="text-red-500 hover:underline">Hapus</button>${teacher.status !== 'disetujui' ? `<button onclick="approveTeacher(${teacher.id})" class="text-green-500 hover:underline">Setujui</button>` : ''}</td></tr>`;
            });
            const teacherManagementHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Manajemen Guru</h2><button onclick="openModal(null, 'guru')" class="bg-teal-500 text-white px-4 py-2 rounded-lg">Tambah Guru</button></div><div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3 font-semibold">Nama</th><th class="p-3 font-semibold">Email</th><th class="p-3 font-semibold">Status</th><th class="p-3 font-semibold">Aksi</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${teacherRows}</tbody></table></div>`;
            
            let studentRows = '';
            users.filter(u => u.role === 'siswa').forEach(student => {
                studentRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${student.nama}</td><td class="p-3">${student.username}</td><td class="p-3">${student.kelas}</td><td class="p-3 space-x-2"><button onclick="openModal(${student.id})" class="text-blue-500 hover:underline">Edit</button><button onclick="handleDeleteUser(${student.id})" class="text-red-500 hover:underline">Hapus</button></td></tr>`;
            });
            const studentManagementHTML = `<div class="mt-8 flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Manajemen Siswa</h2><button onclick="openModal(null, 'siswa')" class="bg-teal-500 text-white px-4 py-2 rounded-lg">Tambah Siswa</button></div><div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3 font-semibold">Nama</th><th class="p-3 font-semibold">Username</th><th class="p-3 font-semibold">Kelas</th><th class="p-3 font-semibold">Aksi</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${studentRows}</tbody></table></div>`;

            // --- BAGIAN REKAP GURU ---
            const today = getTodayDateString();
            const allTeachers = users.filter(u => u.role === 'guru');
            const teacherSummary = { 'Hadir': 0, 'Sakit': 0, 'Izin': 0, 'Belum Absen': 0 };
            let teacherTodayRows = '';
            const statusStyles = { 'Hadir': 'bg-green-100 text-green-800', 'Sakit': 'bg-yellow-100 text-yellow-800', 'Izin': 'bg-blue-100 text-blue-800', 'Alfa': 'bg-red-100 text-red-800', 'Belum Absen': 'bg-gray-200 text-gray-800' };

            allTeachers.forEach(teacher => {
                const attendance = teacherAttendanceRecords.find(r => r.user_id === teacher.id && r.tanggal === today);
                const status = attendance ? attendance.status : 'Belum Absen';
                teacherSummary[status]++;
                teacherTodayRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${teacher.nama}</td><td class="p-3"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusStyles[status]}">${status}</span></td></tr>`;
            });

            const teacherTodayRecapHTML = `
                <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold mb-4">Rekap Absensi Guru Hari Ini (${today})</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-green-700 dark:text-green-300">${teacherSummary['Hadir']}</p><p class="text-sm text-green-600 dark:text-green-400">Hadir</p></div>
                        <div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-yellow-700 dark:text-yellow-300">${teacherSummary['Sakit']}</p><p class="text-sm text-yellow-600 dark:text-yellow-400">Sakit</p></div>
                        <div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-blue-700 dark:text-blue-300">${teacherSummary['Izin']}</p><p class="text-sm text-blue-600 dark:text-blue-400">Izin</p></div>
                        <div class="bg-gray-200 dark:bg-gray-700/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-gray-700 dark:text-gray-300">${teacherSummary['Belum Absen']}</p><p class="text-sm text-gray-600 dark:text-gray-400">Belum Absen</p></div>
                    </div>
                    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
                        <table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700">
                            <tr><th class="p-3 font-semibold">Nama Guru</th><th class="p-3 font-semibold">Status Hari Ini</th></tr>
                        </thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${teacherTodayRows}</tbody></table>
                    </div>
                </div>`;

            let teacherAttendanceRows = '';
            teacherAttendanceRecords.sort((a, b) => b.tanggal.localeCompare(a.tanggal) || b.jam.localeCompare(a.jam)).forEach(rec => {
                const teacher = users.find(u => u.id === rec.user_id);
                if (teacher) { teacherAttendanceRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${teacher.nama}</td><td class="p-3">${rec.tanggal}</td><td class="p-3">${rec.jam}</td><td class="p-3">${rec.status}</td><td class="p-3">${rec.bukti ? `<a href="${rec.bukti}" target="_blank" class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200"><i class="ph-image-square mr-1"></i>Lihat</a>` : '-'}</td></tr>`; }
            });
            const teacherAttendanceHTML = `<div class="mt-8"><h2 class="text-2xl font-bold mb-4">Riwayat Absensi Seluruh Guru</h2><div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3 font-semibold">Nama Guru</th><th class="p-3 font-semibold">Tanggal</th><th class="p-3 font-semibold">Jam</th><th class="p-3 font-semibold">Status</th><th class="p-3 font-semibold">Bukti</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${teacherAttendanceRows}</tbody></table></div></div>`;
            
            // --- BAGIAN REKAP SISWA ---
            const allStudents = users.filter(u => u.role === 'siswa');
            const studentSummary = { 'Hadir': 0, 'Sakit': 0, 'Izin': 0, 'Belum Absen': 0 };
            let studentTodayRows = '';
            allStudents.forEach(student => {
                const attendance = attendanceRecords.find(r => r.user_id === student.id && r.tanggal === today);
                const status = attendance ? attendance.status : 'Belum Absen';
                studentSummary[status]++;
                studentTodayRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${student.nama}</td><td class="p-3">${student.kelas}</td><td class="p-3"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusStyles[status]}">${status}</span></td></tr>`;
            });

            const studentTodayRecapHTML = `
                <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold mb-4">Rekap Absensi Siswa Hari Ini (${today})</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-green-700 dark:text-green-300">${studentSummary['Hadir']}</p><p class="text-sm text-green-600 dark:text-green-400">Hadir</p></div>
                        <div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-yellow-700 dark:text-yellow-300">${studentSummary['Sakit']}</p><p class="text-sm text-yellow-600 dark:text-yellow-400">Sakit</p></div>
                        <div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-blue-700 dark:text-blue-300">${studentSummary['Izin']}</p><p class="text-sm text-blue-600 dark:text-blue-400">Izin</p></div>
                        <div class="bg-gray-200 dark:bg-gray-700/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-gray-700 dark:text-gray-300">${studentSummary['Belum Absen']}</p><p class="text-sm text-gray-600 dark:text-gray-400">Belum Absen</p></div>
                    </div>
                    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
                        <table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700">
                            <tr><th class="p-3 font-semibold">Nama Siswa</th><th class="p-3 font-semibold">Kelas</th><th class="p-3 font-semibold">Status Hari Ini</th></tr>
                        </thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${studentTodayRows}</tbody></table>
                    </div>
                </div>`;

            // --- BAGIAN DIAGRAM (PERINGKAT) ---
            const teacherRankingsHTML = renderAttendanceRankings(allTeachers, 'guru', 'Diagram Peringkat Kehadiran Guru');
            const studentRankingsHTML = renderAttendanceRankings(allStudents, 'siswa', 'Diagram Peringkat Kehadiran Siswa');

            // --- FINAL RETURN (TATA LETAK BARU) ---
            return imageHTML + 
                   teacherManagementHTML + 
                   studentManagementHTML + 
                   teacherTodayRecapHTML + // Rekap Guru
                   teacherRankingsHTML +   // Diagram Peringkat Guru
                   teacherAttendanceHTML + // Riwayat Guru
                   studentTodayRecapHTML + // Rekap Siswa
                   studentRankingsHTML;    // Diagram Peringkat Siswa
        }
        
        function renderGuruDashboard() {
            const imageHTML = `<div class="mb-6"><img src="https://images.unsplash.com/photo-1588075592446-265fd1e6e76f?q=80&w=1472&auto=format&fit=crop" alt="Ilustrasi guru mengajar" class="w-full h-48 object-cover rounded-lg shadow-md"></div>`;
            const today = getTodayDateString();
            const todayAttendance = teacherAttendanceRecords.find(r => r.user_id === currentUser.id && r.tanggal === today);
            let historyRows = '';
            teacherAttendanceRecords.filter(r => r.user_id === currentUser.id).sort((a,b) => b.tanggal.localeCompare(a.tanggal) || b.jam.localeCompare(a.jam)).forEach(rec => { historyRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-2">${rec.tanggal}</td><td class="p-2">${rec.jam}</td><td class="p-2">${rec.status}</td><td class="p-2">${rec.bukti ? `<a href="${rec.bukti}" target="_blank" class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200"><i class="ph-image-square mr-1"></i>Lihat</a>` : '-'}</td></tr>`; });
            let attendanceCardContent = todayAttendance ? `<div class="text-center"><i class="ph-duotone ph-check-circle text-6xl text-green-500"></i><h3 class="text-xl font-bold mt-2">Absensi Berhasil!</h3><p class="text-gray-500 dark:text-gray-400">Anda sudah absen hari ini (${todayAttendance.jam}) dengan status: <strong>${todayAttendance.status}</strong>.</p></div>` 
            : `<p class="mb-4 font-semibold">Anda belum absen hari ini.</p><div class="space-y-4"><select id="status-absen-guru" class="w-full p-2 border rounded-md bg-white dark:bg-gray-800"><option>Hadir</option><option>Izin</option><option>Sakit</option></select><div><p class="text-xs text-gray-500 mb-1">Butuh link untuk bukti? Unggah foto di sini:</p><a href="https://imgbb.com/" target="_blank" class="w-full flex items-center justify-center text-sm bg-gray-200 dark:bg-gray-600 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"><i class="ph-upload-simple mr-2"></i> Unggah ke ImgBB.com</a></div><input type="text" id="bukti-absen-guru" placeholder="Tempel Link Foto Bukti di sini" class="w-full p-2 border rounded-md bg-white dark:bg-gray-800"><button id="submit-absen-guru-btn" class="w-full bg-teal-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-teal-700">Kirim Absen</button></div>`;
            const teacherAttendanceHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="col-span-1 md:col-span-2"><hr class="my-8 border-t-2 border-gray-200 dark:border-gray-700"></div><div><h2 class="flex items-center text-2xl font-bold mb-4"><i class="ph-chalkboard-teacher mr-3 text-teal-400"></i>Absensi Anda Hari Ini</h2><div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow">${attendanceCardContent}</div></div><div><h2 class="flex items-center text-2xl font-bold mb-4"><i class="ph-list-dashes mr-3 text-teal-400"></i>Riwayat Absensi Anda</h2><div class="overflow-y-auto max-h-96 bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700 sticky top-0"><tr><th class="p-2 font-semibold">Tanggal</th><th class="p-2 font-semibold">Jam</th><th class="p-2 font-semibold">Status</th><th class="p-2 font-semibold">Bukti</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${historyRows}</tbody></table></div></div><div class="col-span-1 md:col-span-2"><hr class="my-8 border-t-2 border-gray-200 dark:border-gray-700"></div></div>`;
            
            const studentsInClass = users.filter(u => u.role === 'siswa' && u.kelas === 'XII-D');
            const summary = { 'Hadir': 0, 'Sakit': 0, 'Izin': 0, 'Belum Absen': 0 };
            let studentRows = '';
            studentsInClass.forEach(student => {
                const attendance = attendanceRecords.find(r => r.user_id === student.id && r.tanggal === today);
                const status = attendance ? attendance.status : 'Belum Absen';
                summary[status]++;
                const statusStyles = { 'Hadir': 'bg-green-100 text-green-800', 'Sakit': 'bg-yellow-100 text-yellow-800', 'Izin': 'bg-blue-100 text-blue-800', 'Alfa': 'bg-red-100 text-red-800', 'Belum Absen': 'bg-gray-200 text-gray-800' };
                studentRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${student.nama}</td><td class="p-3"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusStyles[status]}">${status}</span></td></tr>`;
            });
            const todayRecapHTML = `<h2 class="text-2xl font-bold mb-4">Rekap Absensi Siswa Kelas XII-D (${today})</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-green-700 dark:text-green-300">${summary['Hadir']}</p><p class="text-sm text-green-600 dark:text-green-400">Hadir</p></div><div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-yellow-700 dark:text-yellow-300">${summary['Sakit']}</p><p class="text-sm text-yellow-600 dark:text-yellow-400">Sakit</p></div><div class="bg-blue-100 dark:bg-blue-900/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-blue-700 dark:text-blue-300">${summary['Izin']}</p><p class="text-sm text-blue-600 dark:text-blue-400">Izin</p></div><div class="bg-gray-200 dark:bg-gray-700/50 p-4 rounded-lg text-center shadow"><p class="text-3xl font-bold text-gray-700 dark:text-gray-300">${summary['Belum Absen']}</p><p class="text-sm text-gray-600 dark:text-gray-400">Belum Absen</p></div></div><div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3 font-semibold">Nama Siswa</th><th class="p-3 font-semibold">Status Hari Ini</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${studentRows}</tbody></table></div>`;

            let studentHistoryRows = '';
            const studentIdsInClass = studentsInClass.map(s => s.id);
            attendanceRecords.filter(r => studentIdsInClass.includes(r.user_id)).sort((a,b) => b.tanggal.localeCompare(a.tanggal) || b.jam.localeCompare(a.jam)).forEach(rec => {
                const student = users.find(u => u.id === rec.user_id);
                studentHistoryRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-3">${student.nama}</td><td class="p-3">${rec.tanggal}</td><td class="p-3">${rec.jam}</td><td class="p-3">${rec.status}</td><td class="p-3">${rec.bukti ? `<a href="${rec.bukti}" target="_blank" class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200"><i class="ph-image-square mr-1"></i>Lihat</a>` : '-'}</td></tr>`;
            });
            const studentHistoryHTML = `<div class="mt-8"><h2 class="text-2xl font-bold mb-4">Riwayat Absensi Siswa</h2><div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3 font-semibold">Nama Siswa</th><th class="p-3 font-semibold">Tanggal</th><th class="p-3 font-semibold">Jam</th><th class="p-3 font-semibold">Status</th><th class="p-3 font-semibold">Bukti</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${studentHistoryRows}</tbody></table></div></div>`;
            
            // PERBARUAN: Memanggil fungsi renderAttendanceRankings dengan parameter yang benar
            return imageHTML + teacherAttendanceHTML + todayRecapHTML + studentHistoryHTML + renderAttendanceRankings(studentsInClass, 'siswa', 'Diagram Peringkat Kehadiran Siswa');
        }

        function renderSiswaDashboard() {
             const imageHTML = `<div class="mb-6"><img src="https://images.unsplash.com/photo-1509062522246-3755977927d7?q=80&w=1532&auto=format&fit=crop" alt="Ilustrasi siswa belajar" class="w-full h-48 object-cover rounded-lg shadow-md"></div>`;
             const todayAttendance = attendanceRecords.find(r => r.user_id === currentUser.id && r.tanggal === getTodayDateString());
             let historyRows = '';
             attendanceRecords.filter(r => r.user_id === currentUser.id).sort((a,b) => b.tanggal.localeCompare(a.tanggal) || b.jam.localeCompare(a.jam)).forEach(rec => { historyRows += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700"><td class="p-2">${rec.tanggal}</td><td class="p-2">${rec.jam}</td><td class="p-2">${rec.status}</td><td class="p-2">${rec.bukti ? `<a href="${rec.bukti}" target="_blank" class="inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200"><i class="ph-image-square mr-1"></i>Lihat</a>` : '-'}</td></tr>`; });
            let attendanceCardContent = todayAttendance ? `<div class="text-center"><i class="ph-duotone ph-check-circle text-6xl text-green-500"></i><h3 class="text-xl font-bold mt-2">Absensi Berhasil!</h3><p class="text-gray-500 dark:text-gray-400">Anda sudah absen hari ini (${todayAttendance.jam}) dengan status: <strong>${todayAttendance.status}</strong>.</p></div>` 
            : `<p class="mb-4 font-semibold">Anda belum absen hari ini.</p><div class="space-y-4"><select id="status-absen" class="w-full p-2 border rounded-md bg-white dark:bg-gray-800"><option>Hadir</option><option>Izin</option><option>Sakit</option></select><div><p class="text-xs text-gray-500 mb-1">Butuh link untuk bukti? Unggah foto di sini:</p><a href="https://imgbb.com/" target="_blank" class="w-full flex items-center justify-center text-sm bg-gray-200 dark:bg-gray-600 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"><i class="ph-upload-simple mr-2"></i> Unggah ke ImgBB.com</a></div><input type="text" id="bukti-absen" placeholder="Tempel Link Foto Bukti di sini" class="w-full p-2 border rounded-md bg-white dark:bg-gray-800"><button id="submit-absen-btn" class="w-full bg-teal-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-teal-700">Kirim Absen</button></div>`;
            return imageHTML + `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h2 class="flex items-center text-2xl font-bold mb-4"><i class="ph-calendar-check mr-3 text-teal-400"></i>Absensi Hari Ini</h2><div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow">${attendanceCardContent}</div></div><div><h2 class="flex items-center text-2xl font-bold mb-4"><i class="ph-list-checks mr-3 text-teal-400"></i>Riwayat Absensi Anda</h2><div class="overflow-y-auto max-h-96 bg-white dark:bg-gray-800 rounded-lg shadow"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700 sticky top-0"><tr><th class="p-2 font-semibold">Tanggal</th><th class="p-2 font-semibold">Jam</th><th class="p-2 font-semibold">Status</th><th class="p-2 font-semibold">Bukti</th></tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">${historyRows}</tbody></table></div></div></div>`;
        }

        // --- PERBARUAN: Fungsi Diagram Peringkat dibuat Generik ---
        function renderAttendanceRankings(userList, recordType, title) {
            // Tentukan sumber data absensi berdasarkan recordType
            const records = (recordType === 'guru') ? teacherAttendanceRecords : attendanceRecords;
            
            let rankings = userList.map(user => {
                const userRecords = records.filter(r => r.user_id === user.id);
                const hadirCount = userRecords.filter(r => r.status === 'Hadir').length;
                const totalRecords = userRecords.length;
                const percentage = totalRecords > 0 ? Math.round((hadirCount / totalRecords) * 100) : 0;
                return { name: user.nama, percentage };
            }).sort((a, b) => b.percentage - a.percentage);
            
            let rankHTML = '';
            rankings.forEach(rank => { rankHTML += `<div class="mb-2"><div class="flex justify-between mb-1"><span class="text-base font-medium">${rank.name}</span><span class="text-sm font-medium">${rank.percentage}% Hadir</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-teal-500 h-2.5 rounded-full" style="width: ${rank.percentage}%"></div></div></div>`; });
            
            // Gunakan title dinamis
            return `<div class="mt-8"><h2 class="text-2xl font-bold mb-4">${title}</h2><div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">${rankHTML}</div></div>`;
        }
        
        function attachSiswaEventListeners() { const submitBtn = document.getElementById('submit-absen-btn'); if(submitBtn) submitBtn.addEventListener('click', handleAbsenSiswa); }
        function attachGuruEventListeners() { if (currentUser.status === 'disetujui') { const btn = document.getElementById('submit-absen-guru-btn'); if (btn) btn.addEventListener('click', handleAbsenGuru); } }

        // --- ASYNC CRUD & MODAL FUNCTIONS ---
        function openModal(userId = null, role = 'siswa') {
            const modal = document.getElementById('user-modal');
            const title = document.getElementById('modal-title');
            const idInput = document.getElementById('modal-user-id');
            const roleInput = document.getElementById('modal-user-role');
            document.getElementById('modal-error').classList.add('hidden');
            document.getElementById('modal-password').value = '';
            if (userId) { const user = users.find(u => u.id === userId); title.textContent = `Edit Pengguna: ${user.nama}`; idInput.value = user.id; roleInput.value = user.role; document.getElementById('modal-name').value = user.nama; document.getElementById('modal-username').value = user.username; document.getElementById('modal-email').value = user.email; document.getElementById('modal-kelas').value = user.kelas || 'XII-D'; } else { title.textContent = `Tambah ${role === 'siswa' ? 'Siswa' : 'Guru'} Baru`; idInput.value = ''; roleInput.value = role; document.getElementById('modal-name').value = ''; document.getElementById('modal-username').value = ''; document.getElementById('modal-email').value = ''; document.getElementById('modal-kelas').value = 'XII-D'; }
            toggleKelasSelection(true);
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('user-modal').classList.add('hidden'); }
        async function handleSaveUser() {
            showSpinner();
            const id = document.getElementById('modal-user-id').value, role = document.getElementById('modal-user-role').value, name = document.getElementById('modal-name').value, username = document.getElementById('modal-username').value, email = document.getElementById('modal-email').value, password = document.getElementById('modal-password').value, kelas = document.getElementById('modal-kelas').value, errorDiv = document.getElementById('modal-error');
            if (!name || !username || !email) { errorDiv.textContent = "Nama, Username, dan Email wajib diisi."; errorDiv.classList.remove('hidden'); hideSpinner(); return; }
            
            const { data: existingUser, error: findError } = await supabase.from('user').select('id').or(`username.eq.${username},email.eq.${email}`).not('id', 'eq', id || 0); // Ganti 'users' menjadi 'user'
            if (findError) { console.error(findError); hideSpinner(); return; }
            if (existingUser.length > 0) { errorDiv.textContent = "Username atau Email sudah digunakan."; errorDiv.classList.remove('hidden'); hideSpinner(); return; }

            let userData = { nama: name, username, email, role, ...(role === 'siswa' && { kelas }) };
            if (password) userData.password = password;
            
            if (id) {
                const { error } = await supabase.from('user').update(userData).eq('id', id); // Ganti 'users' menjadi 'user'
                if (error) { console.error("Update error:", error); hideSpinner(); return; }
            } else {
                if (!password) { errorDiv.textContent = "Password wajib diisi untuk pengguna baru."; errorDiv.classList.remove('hidden'); hideSpinner(); return; }
                userData.status = role === 'guru' ? 'menunggu persetujuan' : 'aktif';
                const { error } = await supabase.from('user').insert([userData]); // Ganti 'users' menjadi 'user'
                if (error) { console.error("Insert error:", error); hideSpinner(); return; }
            }
            await loadAllData();
            closeModal();
            renderDashboard();
        }
        async function handleDeleteUser(userId) {
            if (window.confirm('Apakah Anda yakin ingin menghapus pengguna ini? Semua data absensi terkait juga akan dihapus.')) {
                showSpinner();
                const userToDelete = users.find(u => u.id === userId);
                if (userToDelete.role === 'guru') { await supabase.from('teacher_attendance_records').delete().eq('user_id', userId); } 
                else { await supabase.from('attendance_records').delete().eq('user_id', userId); }
                await supabase.from('user').delete().eq('id', userId); // Ganti 'users' menjadi 'user'
                await loadAllData();
                renderDashboard();
            }
        }

        // --- ASYNC AUTH & OTHER ACTIONS ---
        async function handleRegister() {
            showSpinner();
            const email = document.getElementById('register-email').value, password = document.getElementById('register-password').value, nama = document.getElementById('register-name').value, username = document.getElementById('register-username').value, role = document.getElementById('register-role').value, kelas = document.getElementById('register-kelas').value, registerError = document.getElementById('register-error');
            if (!email || !password || !nama || !username) { registerError.textContent = "Mohon isi semua field."; registerError.classList.remove('hidden'); hideSpinner(); return; }
            
            const { data: existingUser, error: findError } = await supabase.from('user').select('id').or(`username.eq.${username},email.eq.${email}`); // Ganti 'users' menjadi 'user'
            if (findError) { console.error(findError); hideSpinner(); return; }
            if (existingUser.length > 0) { registerError.textContent = "Email atau Username sudah terdaftar."; registerError.classList.remove('hidden'); hideSpinner(); return; }

            const newUser = { username, email, password, nama, role, status: role === 'guru' ? 'menunggu persetujuan' : 'aktif', ...(role === 'siswa' && { kelas }) };
            const { error: insertError } = await supabase.from('user').insert([newUser]); // Ganti 'users' menjadi 'user'
            if (insertError) { console.error("Register error:", insertError); hideSpinner(); return; }
            
            await loadAllData();
            hideSpinner();
            alert('Registrasi berhasil! Silakan login.'); registerError.classList.add('hidden'); showPage('login-page');
        };

        async function handleLogin() {
            showSpinner();
            const username = document.getElementById('login-username').value, password = document.getElementById('login-password').value, loginError = document.getElementById('login-error');
            
            if (!supabase) {
                loginError.textContent = "Koneksi Supabase Gagal. Periksa konfigurasi.";
                loginError.classList.remove('hidden');
                hideSpinner();
                return;
            }

            // WARNING: Storing and checking plain text passwords is not secure for production.
            // Use Supabase Auth for a real application. This is for simplicity in this context.
            const { data, error } = await supabase.from('user').select('*').eq('username', username).eq('password', password).single(); // Ganti 'users' menjadi 'user'

            // --- PERBAIKAN ---
            // Logika penanganan error yang lebih baik
            if (error) {
                // Jangan tampilkan error PGRST116 (data tidak ditemukan) di konsol
                if (error.code !== 'PGRST116') {
                    console.error("Login error:", error);
                }
                
                // Tangani error "Failed to fetch"
                if (error.message.includes("Failed to fetch")) {
                    loginError.textContent = "Gagal terhubung ke server. Periksa koneksi/URL Supabase.";
                } 
                // Tangani error "Username/password salah" (PGRST116 = tidak ada baris ditemukan)
                else if (error.code === 'PGRST116') {
                    loginError.textContent = "Username atau password salah.";
                } 
                // Tangani error lain
                else {
                    loginError.textContent = "Terjadi kesalahan: " + error.message;
                }
                loginError.classList.remove('hidden');
                hideSpinner();
                return;
            }
            
            // Jika tidak ada error DAN data ditemukan
            if (data) { 
                currentUser = data; 
                loginError.classList.add('hidden'); 
                await loadAllData(); 
                showPage('dashboard-page'); 
                renderDashboard();
            } else {
                // Fallback jika error null tapi data juga null (seharusnya tidak terjadi dengan .single())
                loginError.textContent = "Username atau password salah."; 
                loginError.classList.remove('hidden'); 
                hideSpinner();
            }
        };

        function handleLogout() { currentUser = null; showPage('login-page'); };

        async function approveTeacher(uid) { 
            showSpinner();
            await supabase.from('user').update({ status: 'disetujui' }).eq('id', uid); // Ganti 'users' menjadi 'user'
            await loadAllData();
            renderDashboard();
        }
        async function handleAbsenSiswa() {
            showSpinner();
            const status = document.getElementById('status-absen').value, bukti = document.getElementById('bukti-absen').key;
            if ((status === 'Izin' || status === 'Sakit') && !bukti) { alert('Mohon sertakan link bukti untuk status Izin atau Sakit.'); hideSpinner(); return; }
            const newRecord = { user_id: currentUser.id, tanggal: getTodayDateString(), jam: getCurrentTimeString(), status, bukti, kelas: currentUser.kelas };
            await supabase.from('attendance_records').insert([newRecord]);
            await loadAllData();
            alert('Absensi berhasil disimpan!');
            renderDashboard();
        }
        async function handleAbsenGuru() {
            showSpinner();
            const status = document.getElementById('status-absen-guru').value, bukti = document.getElementById('bukti-absen-guru').value;
            if ((status === 'Izin' || status === 'Sakit') && !bukti) { alert('Mohon sertakan link bukti untuk status Izin atau Sakit.'); hideSpinner(); return; }
            const newRecord = { user_id: currentUser.id, tanggal: getTodayDateString(), jam: getCurrentTimeString(), status, bukti };
            await supabase.from('teacher_attendance_records').insert([newRecord]);
            await loadAllData();
            alert('Absensi berhasil disimpan!');
            renderDashboard();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => { 
            if (!supabase) {
                // Pesan error sudah ditampilkan oleh block 'catch' di atas.
                // Kita hanya perlu memastikan spinner disembunyikan.
                hideSpinner();
                // Tampilkan halaman login-nya, tapi error akan terlihat di atasnya.
                showPage('login-page');
                const loginError = document.getElementById('login-error');
                if (loginError && !loginError.textContent) {
                    loginError.textContent = "Konfigurasi Supabase Gagal! Periksa konsol (F12) untuk detail.";
                    loginError.classList.remove('hidden');
                }
            } else {
                hideSpinner();
                showPage('login-page'); 
            }
        });
    </script>
</body>
</html>
